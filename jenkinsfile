pipeline {
     withCredentials([file(credentialsId: 'key-sa', variable: 'GC_KEY')]) {
    sh("gcloud auth activate-service-account --key-file=${GC_KEY}")
    sh("gcloud container clusters get-credentials prod --zone northamerica-northeast1-a --project ${project}")
  }
           agent any
           stages {
                stage("Hello") {
                     steps {
                          script {
               currentBuild.displayName = sh (script: 'git log -1 --pretty=%B ${GIT_COMMIT}', returnStdout: true).trim()
                        }        
                         echo "Hello World"
                         sh 'export GOOGLE_APPLICATION_CREDENTIALS="/home/averboonen/Task1_key.json" '
                     }
                }
                 stage("TERRA") {
                     steps {
                          sh '/home/averboonen/google-cloud-sdk/bin/gcloud auth activate-service-account --key-file="/home/averboonen/Task1_key.json"'
                          //sh '/home/averboonen/google-cloud-sdk/bin/gcloud auth application-default login'
                         //sh 'terraform init'
                          // sh 'terrafor plan'
                     }
                }
                stage("Mover Archivo") {
                     steps {
                          script {
                         //touch "archivo_prueba$(date +_%Y%m%d_%H%M).txt"
                         sh '/home/averboonen/google-cloud-sdk/bin/gcloud config set core/project alex-verboonen-2022-run-5'
                         sh '/home/averboonen/google-cloud-sdk/bin/gcloud pubsub subscriptions pull example-subscription --format=json >> "archivo_prueba$(date +_%Y%m%d_%H%M).txt"'
                         sh '/home/averboonen/google-cloud-sdk/bin/gsutil cp "archivo_prueba$(date +_%Y%m%d_%H%M).txt" gs://bucket-alexv-task1'
                          }
                     }
                }
           }
      }
